<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: setupTerminal.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: setupTerminal.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Secure audited WebSocket terminal setup.
 * Provides a restricted command execution environment with Firebase authentication and audit logging.
 * @module setupTerminal
 */

import { WebSocketServer } from 'ws';
import { spawn } from 'child_process';
import { getAuth } from 'firebase-admin/auth';
import path from 'path';
import fs from 'fs';

const SAFE_DIR = path.resolve('./projects/demo');
const MAX_MSG_LEN = 10_000;

// Ensure safe directory exists
if (!fs.existsSync(SAFE_DIR)) {
  console.error(`âš ï¸ Safe directory ${SAFE_DIR} does not exist. Please create the folder before starting the server.`);
}

const isWin = process.platform === 'win32';

/**
 * Allowed command mappings depending on platform.
 */
const mapCommands = {
  ls: isWin ? { cmd: 'cmd', args: ['/c', 'dir'] } : { cmd: 'ls', args: [] },
  pwd: isWin ? { cmd: 'cmd', args: ['/c', 'cd'] } : { cmd: 'pwd', args: [] },
  cat: isWin ? { cmd: 'cmd', args: ['/c', 'type'] } : { cmd: 'cat', args: [] },
  less: isWin ? null : { cmd: 'less', args: [] },
  head: isWin ? null : { cmd: 'head', args: [] },
  tail: isWin ? null : { cmd: 'tail', args: [] },
};

/**
 * Sanitizes arguments by removing ANSI escape sequences.
 *
 * @param {string[]} args - Command arguments.
 * @returns {string[]} Sanitized arguments.
 */
function sanitizeArgs(args) {
  return args.map((a) => a.replace(/\x1B\[[0-9;]*[A-Za-z]/g, ''));
}

/**
 * Sends text to the WebSocket client with CRLF normalization.
 *
 * @param {WebSocket} ws - WebSocket connection.
 * @param {string} text - Text to send.
 */
function sendText(ws, text) {
  if (ws.readyState === ws.OPEN) {
    ws.send(String(text).replace(/\n/g, '\r\n'), { binary: false });
  }
}

/**
 * Sets up a secure audited WebSocket terminal.
 *
 * @function setupTerminal
 * @param {Server} server - HTTP server instance.
 */
export function setupTerminal(server) {
  const wss = new WebSocketServer({
    server,
    path: '/terminal-audit',
    perMessageDeflate: false,
  });

  wss.on('connection', async (ws, req) => {
    let userId = 'anon';
    let token = null;

    const protocols = req.headers['sec-websocket-protocol'];
    if (protocols) {
      const protoList = protocols.split(',').map((p) => p.trim());
      token = protoList[0];
    }

    if (!token) {
      sendText(ws, 'âŒ Token not received\n');
      ws.close(1008, 'No token');
      return;
    }

    try {
      const decoded = await getAuth().verifyIdToken(token);
      userId = decoded.uid;
      console.log(`ðŸ” Authenticated user: ${decoded.email}`);
    } catch {
      sendText(ws, 'âŒ Invalid token\n');
      ws.close(1008, 'Invalid token');
      return;
    }

    sendText(
      ws,
      `Welcome to the secure terminal!\nAllowed commands: ls, pwd, cat, less, head, tail\nDirectory: ${SAFE_DIR}\n`
    );

    // Keepalive ping
    const pingInterval = setInterval(() => {
      if (ws.readyState === ws.OPEN) {
        ws.ping();
      }
    }, 25_000);

    ws.on('message', async (msg) => {
      const raw = msg.toString().trim();

      if (raw === '__ping__') return;

      if (raw.length > MAX_MSG_LEN) {
        sendText(ws, 'âŒ Input too long\n');
        return;
      }

      const [command, ...args] = raw.split(/\s+/);

      if (!mapCommands[command]) {
        sendText(ws, `âŒ Command not allowed: ${command}\n`);
        return;
      }

      const { cmd, args: baseArgs } = mapCommands[command];
      const cleanArgs = sanitizeArgs([...baseArgs, ...args]);

      const child = spawn(cmd, cleanArgs, {
        shell: false,
        cwd: SAFE_DIR,
        env: process.env,
      });

      child.stdout.on('data', (d) => sendText(ws, d.toString()));
      child.stderr.on('data', (d) => sendText(ws, `Error: ${d.toString()}`));
      child.on('close', (code) =>
        sendText(ws, `Process finished with exit code ${code}\n`)
      );
    });

    ws.on('close', () => {
      clearInterval(pingInterval);
      console.log(`ðŸ”’ Client ${userId} disconnected from audited terminal`);
    });

    ws.on('error', (err) => {
      clearInterval(pingInterval);
      console.error(`ðŸ’¥ WebSocket connection error:`, err);
      try {
        ws.close();
      } catch {}
    });
  });

  console.log(
    `ðŸ”’ Audited terminal mounted at /terminal-audit (directory: ${SAFE_DIR})`
  );
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="-__tests___app.module_test.html">__tests__/app.test</a></li><li><a href="babel.module_config.html">babel.config</a></li><li><a href="eslint.module_config.html">eslint.config</a></li><li><a href="jest.module_config.html">jest.config</a></li><li><a href="jest.module_setup.html">jest.setup</a></li><li><a href="module-DB_db.html">DB/db</a></li><li><a href="module-__mocks___firebase-admin.html">__mocks__/firebase-admin</a></li><li><a href="module-app.html">app</a></li><li><a href="module-authMiddlewareMock.html">authMiddlewareMock</a></li><li><a href="module-checkRoleMock.html">checkRoleMock</a></li><li><a href="module-config_envConfig.html">config/envConfig</a></li><li><a href="module-config_firebase.html">config/firebase</a></li><li><a href="module-controllers_assistantController.html">controllers/assistantController</a></li><li><a href="module-controllers_autocompleteController.html">controllers/autocompleteController</a></li><li><a href="module-controllers_avatarController.html">controllers/avatarController</a></li><li><a href="module-controllers_codeController.html">controllers/codeController</a></li><li><a href="module-controllers_generateController.html">controllers/generateController</a></li><li><a href="module-controllers_lintController.html">controllers/lintController</a></li><li><a href="module-controllers_projectController.html">controllers/projectController</a></li><li><a href="module-controllers_projectFilesController.html">controllers/projectFilesController</a></li><li><a href="module-controllers_registerController.html">controllers/registerController</a></li><li><a href="module-controllers_taskController.html">controllers/taskController</a></li><li><a href="module-controllers_user_syncUser.html">controllers/user/syncUser</a></li><li><a href="module-controllers_user_syncUserToMongo.html">controllers/user/syncUserToMongo</a></li><li><a href="module-controllers_user_updateUserRole.html">controllers/user/updateUserRole</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_userProfileController.html">controllers/userProfileController</a></li><li><a href="module-lint_lintRunner.html">lint/lintRunner</a></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a></li><li><a href="module-middleware_checkRole.html">middleware/checkRole</a></li><li><a href="module-middleware_errorHandlers.html">middleware/errorHandlers</a></li><li><a href="module-middleware_smartOriginValidator.html">middleware/smartOriginValidator</a></li><li><a href="module-middleware_validateOrigin.html">middleware/validateOrigin</a></li><li><a href="module-models_KanbanList.html">models/KanbanList</a></li><li><a href="module-models_LocalList.html">models/LocalList</a></li><li><a href="module-models_Project.html">models/Project</a></li><li><a href="module-models_ProjectFile.html">models/ProjectFile</a></li><li><a href="module-models_Session.html">models/Session</a></li><li><a href="module-models_Task.html">models/Task</a></li><li><a href="module-models_User.html">models/User</a></li><li><a href="module-models_UserProfile.html">models/UserProfile</a></li><li><a href="module-routes_assistantRoutes.html">routes/assistantRoutes</a></li><li><a href="module-routes_autocompleteRoutes.html">routes/autocompleteRoutes</a></li><li><a href="module-routes_avatarRoutes.html">routes/avatarRoutes</a></li><li><a href="module-routes_codeRoutes.html">routes/codeRoutes</a></li><li><a href="module-routes_generateRoutes.html">routes/generateRoutes</a></li><li><a href="module-routes_lintRoutes.html">routes/lintRoutes</a></li><li><a href="module-routes_projectFilesRoutes.html">routes/projectFilesRoutes</a></li><li><a href="module-routes_projectRoutes.html">routes/projectRoutes</a></li><li><a href="module-routes_registerRoutes.html">routes/registerRoutes</a></li><li><a href="module-routes_roleRoutes.html">routes/roleRoutes</a></li><li><a href="module-routes_taskRoutes.html">routes/taskRoutes</a></li><li><a href="module-routes_userProfileRoutes.html">routes/userProfileRoutes</a></li><li><a href="module-routes_userRoutes.html">routes/userRoutes</a></li><li><a href="module-schemas_kanbanListSchema.html">schemas/kanbanListSchema</a></li><li><a href="module-schemas_localListSchema.html">schemas/localListSchema</a></li><li><a href="module-schemas_projectFileSchema.html">schemas/projectFileSchema</a></li><li><a href="module-schemas_projectSchema.html">schemas/projectSchema</a></li><li><a href="module-schemas_sessionSchema.html">schemas/sessionSchema</a></li><li><a href="module-schemas_taskSchema.html">schemas/taskSchema</a></li><li><a href="module-schemas_userProfileSchema.html">schemas/userProfileSchema</a></li><li><a href="module-schemas_userSchema.html">schemas/userSchema</a></li><li><a href="module-security.html">security</a></li><li><a href="module-server.html">server</a></li><li><a href="module-services_assistantService.html">services/assistantService</a></li><li><a href="module-services_fastapiModelRunner.html">services/fastapiModelRunner</a></li><li><a href="module-setupTerminal.html">setupTerminal</a></li><li><a href="module-smartOriginValidatorMock.html">smartOriginValidatorMock</a></li><li><a href="module-utils_buildTree.html">utils/buildTree</a></li><li><a href="module-utils_roleUtils.html">utils/roleUtils</a></li><li><a href="module-utils_utils.html">utils/utils</a></li><li><a href="module-validateOriginMock.html">validateOriginMock</a></li></ul><h3>Global</h3><ul><li><a href="global.html#updateUserRole">updateUserRole</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Feb 14 2026 22:15:05 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
