<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: __tests__/app.test.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: __tests__/app.test.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Test suite for the Express application.
 * This file contains integration tests for routes, middleware mocks,
 * and protected endpoints. It ensures that the backend behaves correctly
 * under different scenarios such as authentication, role-based access,
 * and error handling.
 * @module __tests__/app.test
 */

import request from "supertest";
import { app } from "../app.js";

/**
 * Mock for authentication middleware.
 * Simulates an authenticated user with a configurable role.
 * @module authMiddlewareMock
 */

jest.mock('firebase-admin');

jest.mock("../middleware/authMiddleware.js", () => ({
  auth: (req, res, next) => {
    req.user = { username: "testuser", role: req.headers["x-role"] || "USER" };
    next();
  },
}));

/**
 * Mock for role-checking middleware.
 * Ensures that only allowed roles can access certain routes.
 * @module checkRoleMock
 */
jest.mock("../middleware/checkRole.js", () => ({
  checkRole: (roles) => (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: "Forbidden" });
    }
    next();
  },
}));

/**
 * Mock for origin validation middleware.
 * Always passes validation in test environment.
 * @module validateOriginMock
 */
jest.mock("../middleware/validateOrigin.js", () => ({
  validateOrigin: (req, res, next) => next(),
}));

/**
 * Mock for smart origin validator middleware.
 * Always passes validation in test environment.
 * @module smartOriginValidatorMock
 */
jest.mock("../middleware/smartOriginValidator.js", () => ({
  smartOriginValidator: (req, res, next) => next(),
}));

/**
 * Test suite for Express application routes.
 */
describe("Express app", () => {
  /**
   * Root route test.
   * Should return welcome message.
   */
  test("GET / returns welcome message", async () => {
    const res = await request(app).get("/");
    expect(res.statusCode).toBe(200);
    expect(res.text).toContain("Welcome to the secure and monitored platform.");
  });

  /**
   * API route test.
   * Should return pong message ðŸš€.
   */
  test("GET /api returns pong", async () => {
    const res = await request(app).get("/api");
    expect(res.statusCode).toBe(200);
    expect(res.body).toEqual({ message: "pong from Express backend ðŸš€" });
  });

  /**
   * Health check route test.
   * Should return status ok.
   */
  test("GET /health returns ok", async () => {
    const res = await request(app).get("/health");
    expect(res.statusCode).toBe(200);
    expect(res.body).toEqual({ status: "ok" });
  });

  /**
   * Protected route tests for /admin-only.
   */
  describe("Protected route /admin-only", () => {
    test("without authentication defaults to USER role and returns 403", async () => {
      const res = await request(app).get("/admin-only");
      expect(res.statusCode).toBe(403);
    });

    test("with non-ADMIN role returns 403", async () => {
      const res = await request(app).get("/admin-only").set("x-role", "MANAGER");
      expect(res.statusCode).toBe(403);
      expect(res.body).toEqual({ error: "Forbidden" });
    });

    test("with ADMIN role returns access", async () => {
      const res = await request(app).get("/admin-only").set("x-role", "ADMIN");
      expect(res.statusCode).toBe(200);
      expect(res.body.message).toContain("Hi testuser, you have admin access ðŸ”‘");
    });
  });

  /**
   * Non-existent API route test.
   * Should return specific error message.
   */
  test("non-existent route under /api returns specific error", async () => {
    const res = await request(app).get("/api/does-not-exist");
    expect(res.statusCode).toBe(404);
    expect(res.body).toEqual({ error: "Route /api not found" });
  });

  /**
   * Global non-existent route test.
   * Should return generic error message.
   */
  test("global non-existent route returns generic error", async () => {
    const res = await request(app).get("/no-such-route");
    expect(res.statusCode).toBe(404);
    expect(res.body).toEqual({ error: "Route not found" });
  });
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="-__tests___app.module_test.html">__tests__/app.test</a></li><li><a href="babel.module_config.html">babel.config</a></li><li><a href="eslint.module_config.html">eslint.config</a></li><li><a href="jest.module_config.html">jest.config</a></li><li><a href="jest.module_setup.html">jest.setup</a></li><li><a href="module-DB_db.html">DB/db</a></li><li><a href="module-__mocks___firebase-admin.html">__mocks__/firebase-admin</a></li><li><a href="module-app.html">app</a></li><li><a href="module-authMiddlewareMock.html">authMiddlewareMock</a></li><li><a href="module-checkRoleMock.html">checkRoleMock</a></li><li><a href="module-config_envConfig.html">config/envConfig</a></li><li><a href="module-config_firebase.html">config/firebase</a></li><li><a href="module-controllers_assistantController.html">controllers/assistantController</a></li><li><a href="module-controllers_autocompleteController.html">controllers/autocompleteController</a></li><li><a href="module-controllers_avatarController.html">controllers/avatarController</a></li><li><a href="module-controllers_codeController.html">controllers/codeController</a></li><li><a href="module-controllers_generateController.html">controllers/generateController</a></li><li><a href="module-controllers_lintController.html">controllers/lintController</a></li><li><a href="module-controllers_projectController.html">controllers/projectController</a></li><li><a href="module-controllers_projectFilesController.html">controllers/projectFilesController</a></li><li><a href="module-controllers_registerController.html">controllers/registerController</a></li><li><a href="module-controllers_replyCodeOnlyController.html">controllers/replyCodeOnlyController</a></li><li><a href="module-controllers_roleController.html">controllers/roleController</a></li><li><a href="module-controllers_taskController.html">controllers/taskController</a></li><li><a href="module-controllers_user_syncUser.html">controllers/user/syncUser</a></li><li><a href="module-controllers_user_syncUserToMongo.html">controllers/user/syncUserToMongo</a></li><li><a href="module-controllers_userController.html">controllers/userController</a></li><li><a href="module-controllers_userProfileController.html">controllers/userProfileController</a></li><li><a href="module-lint_lintRunner.html">lint/lintRunner</a></li><li><a href="module-middleware_authMiddleware.html">middleware/authMiddleware</a></li><li><a href="module-middleware_checkRole.html">middleware/checkRole</a></li><li><a href="module-middleware_errorHandlers.html">middleware/errorHandlers</a></li><li><a href="module-middleware_smartOriginValidator.html">middleware/smartOriginValidator</a></li><li><a href="module-middleware_validateOrigin.html">middleware/validateOrigin</a></li><li><a href="module-models_KanbanList.html">models/KanbanList</a></li><li><a href="module-models_LocalList.html">models/LocalList</a></li><li><a href="module-models_Project.html">models/Project</a></li><li><a href="module-models_ProjectFile.html">models/ProjectFile</a></li><li><a href="module-models_Session.html">models/Session</a></li><li><a href="module-models_Task.html">models/Task</a></li><li><a href="module-models_User.html">models/User</a></li><li><a href="module-models_UserProfile.html">models/UserProfile</a></li><li><a href="module-routes_assistantRoutes.html">routes/assistantRoutes</a></li><li><a href="module-routes_avatarRoutes.html">routes/avatarRoutes</a></li><li><a href="module-routes_codeRoutes.html">routes/codeRoutes</a></li><li><a href="module-routes_lintRoutes.html">routes/lintRoutes</a></li><li><a href="module-routes_projectFilesRoutes.html">routes/projectFilesRoutes</a></li><li><a href="module-routes_projectRoutes.html">routes/projectRoutes</a></li><li><a href="module-routes_registerRoutes.html">routes/registerRoutes</a></li><li><a href="module-routes_taskRoutes.html">routes/taskRoutes</a></li><li><a href="module-routes_userProfileRoutes.html">routes/userProfileRoutes</a></li><li><a href="module-routes_userRoutes.html">routes/userRoutes</a></li><li><a href="module-schemas_kanbanListSchema.html">schemas/kanbanListSchema</a></li><li><a href="module-schemas_localListSchema.html">schemas/localListSchema</a></li><li><a href="module-schemas_projectFileSchema.html">schemas/projectFileSchema</a></li><li><a href="module-schemas_projectSchema.html">schemas/projectSchema</a></li><li><a href="module-schemas_sessionSchema.html">schemas/sessionSchema</a></li><li><a href="module-schemas_taskSchema.html">schemas/taskSchema</a></li><li><a href="module-schemas_userProfileSchema.html">schemas/userProfileSchema</a></li><li><a href="module-schemas_userSchema.html">schemas/userSchema</a></li><li><a href="module-security.html">security</a></li><li><a href="module-server.html">server</a></li><li><a href="module-services_assistantService.html">services/assistantService</a></li><li><a href="module-services_fastapiModelRunner.html">services/fastapiModelRunner</a></li><li><a href="module-services_userService.html">services/userService</a></li><li><a href="module-setupTerminal.html">setupTerminal</a></li><li><a href="module-smartOriginValidatorMock.html">smartOriginValidatorMock</a></li><li><a href="module-utils_buildTree.html">utils/buildTree</a></li><li><a href="module-utils_roleUtils.html">utils/roleUtils</a></li><li><a href="module-utils_utils.html">utils/utils</a></li><li><a href="module-validateOriginMock.html">validateOriginMock</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Feb 26 2026 10:36:16 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
